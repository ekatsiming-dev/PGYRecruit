<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 PGY ç”„é¸å ±åè³‡æ–™åˆ†æå„€è¡¨æ¿</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#003566', // Deep Blue
                        secondary: '#fca311', // Amber
                        accent: '#fef9c3', // Light Yellow
                        bg: '#f8fafc', // Slate 50
                        surface: '#ffffff',
                        success: '#10b981', // Emerald
                        danger: '#ef4444', // Red
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #fca311; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Tag Styles */
        .tag { padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; margin-right: 4px; display: inline-block; margin-bottom: 2px;}
        .tag-blue { background: #e0f2fe; color: #0369a1; }
        .tag-amber { background: #fef3c7; color: #b45309; }
        .tag-green { background: #d1fae5; color: #047857; }
        .tag-slate { background: #f1f5f9; color: #475569; }
        .tag-red { background: #fee2e2; color: #b91c1c; }
        .tag-pink { background: #fce7f3; color: #be185d; } /* New Pink Style */
    </style>
</head>
<body class="text-slate-800">

    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-primary/90 z-50 flex flex-col items-center justify-center text-white">
        <div class="loading-spinner mb-4"></div>
        <h2 class="text-xl font-bold">æ­£åœ¨è®€å– 2026 PGY ç”„é¸è³‡æ–™...</h2>
        <p class="text-sm opacity-80 mt-2">åˆ†ææ¨£æœ¬ç¸½æ•¸ï¼š235</p>
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 py-8 opacity-0 transition-opacity duration-700" id="main-content">
        
        <!-- Header -->
        <header class="mb-8 border-l-4 border-secondary pl-4 flex flex-col md:flex-row md:justify-between md:items-end">
            <div>
                <h1 class="text-3xl font-bold text-primary">2026 PGY ç”„é¸å ±åè³‡æ–™åˆ†æå„€è¡¨æ¿</h1>
                <p class="text-slate-500 mt-1">æ·±åº¦è³‡è³ªåˆ†æï¼šå‡å€¼/ä¸­ä½æ•¸åæ…‹åµæ¸¬ | æ€§åˆ¥çµæ§‹ | åŒ—éƒ¨ç”Ÿæºåµæ¸¬</p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <span class="text-xs bg-primary text-white px-2 py-1 rounded">2026 Selection</span>
            </div>
        </header>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card p-6 border-t-4 border-primary">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">ç¸½æ¨£æœ¬æ•¸ (æœ‰æ•ˆçµ„åˆ¥)</p>
                        <h3 class="text-3xl font-bold text-primary mt-1" id="total-students">0</h3>
                    </div>
                    <div class="p-2 bg-blue-50 rounded-lg text-primary">
                        <i class="ph ph-users text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="card p-6 border-t-4 border-secondary">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">å…¨é«” GPA å¹³å‡</p>
                        <h3 class="text-3xl font-bold text-secondary mt-1" id="overall-gpa">0.00</h3>
                    </div>
                    <div class="p-2 bg-amber-50 rounded-lg text-secondary">
                        <i class="ph ph-exam text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="card p-6 border-t-4 border-secondary">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">å—éƒ¨ç”Ÿæºç¸½ä½”æ¯”</p>
                        <h3 class="text-3xl font-bold text-secondary mt-1" id="south-ratio">0%</h3>
                        <p class="text-xs text-slate-400 mt-1">åŒ…å«å°å—åŠå…¶ä»–å—éƒ¨</p>
                    </div>
                    <div class="p-2 bg-amber-50 rounded-lg text-secondary">
                        <i class="ph ph-house-line text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="card p-6 border-t-4 border-slate-400">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">å…¨é«” GPA æ¨™æº–å·®</p>
                        <h3 class="text-3xl font-bold text-slate-600 mt-1" id="overall-sd">0.00</h3>
                        <p class="text-xs text-slate-400 mt-1">æ•¸å€¼è¶Šä½ä»£è¡¨ç´ è³ªè¶Šæ•´é½Š</p>
                    </div>
                    <div class="p-2 bg-slate-100 rounded-lg text-slate-600">
                        <i class="ph ph-activity text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section 1: Performance -->
        <div class="card p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-primary flex items-center">
                    <i class="ph ph-trend-up mr-2"></i> å„çµ„æˆç¸¾ GPA è³‡è³ªåˆ†æ
                </h3>
                <div class="flex gap-2">
                     <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">é•·æ¢ï¼šå¹³å‡ GPA</span>
                     <span class="text-xs px-2 py-1 bg-amber-100 text-amber-800 rounded">æŠ˜ç·šï¼šæ¨™æº–å·®</span>
                </div>
            </div>
            <div class="relative h-64">
                <canvas id="gpaChart"></canvas>
            </div>
            <p class="text-xs text-slate-400 mt-2 text-center">*æ¨™æº–å·® (æŠ˜ç·š) è¶Šä½ä»£è¡¨è©²çµ„æˆç¸¾è¶Šæ•´é½Šï¼Œè¶Šé«˜ä»£è¡¨è½å·®è¶Šå¤§</p>
        </div>

        <!-- Chart Section 2: Demographics (Side by Side) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            
            <!-- Location Distribution -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-primary flex items-center">
                        <i class="ph ph-map-trifold mr-2"></i> å±…ä½åœ°æºæ¯”ç‡(100%)
                    </h3>
                </div>
                <div class="relative h-72">
                    <canvas id="locationChart"></canvas>
                </div>
                <div class="flex flex-wrap justify-center gap-2 mt-2 text-xs text-slate-500">
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-[#fca311] mr-1"></div>å—éƒ¨ (å«å°å—)</span>
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-[#003566] mr-1"></div>åŒ—éƒ¨</span>
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-[#cbd5e1] mr-1"></div>å…¶ä»–</span>
                </div>
                <p class="text-xs text-center text-slate-400 mt-2">* æ‡¸åœåœ–è¡¨å¯æŸ¥çœ‹å¯¦éš›äººæ•¸</p>
            </div>

            <!-- Gender Distribution -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-primary flex items-center">
                        <i class="ph ph-gender-intersex mr-2"></i> å„çµ„æ€§åˆ¥æ¯”ç‡ (100%)
                    </h3>
                </div>
                <div class="relative h-72">
                    <canvas id="genderChart"></canvas>
                </div>
                 <div class="flex justify-center gap-4 mt-2 text-xs text-slate-500">
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-[#60a5fa] mr-1"></div>ç”·æ€§</span>
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-[#f472b6] mr-1"></div>å¥³æ€§</span>
                </div>
                <p class="text-xs text-center text-slate-400 mt-2">* æ‡¸åœåœ–è¡¨å¯æŸ¥çœ‹å¯¦éš›äººæ•¸</p>
            </div>
        </div>

        <!-- Insight & Stats Table -->
        <div class="card overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h3 class="text-lg font-bold text-primary flex items-center">
                        <i class="ph ph-lightning mr-2 text-secondary"></i> PGY å„çµ„ç‰¹æ€§æ™ºèƒ½åˆ†æ
                    </h3>
                    <p class="text-xs text-slate-400 mt-1">åŒ…å«è³‡è³ªåæ…‹åˆ†æ(å‡å€¼vsä¸­ä½æ•¸)ã€æ€§åˆ¥èˆ‡åœ°ç·£ç‰¹æ€§</p>
                </div>
                <button onclick="exportTableToCSV()" class="text-sm bg-primary text-white px-4 py-2 rounded hover:bg-blue-800 transition shadow-sm">
                    <i class="ph ph-download-simple mr-1"></i> åŒ¯å‡ºåˆ†æå ±å‘Š
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                        <tr>
                            <th class="px-4 py-3 min-w-[100px]">ç¾¤é«”åç¨±</th>
                            <th class="px-4 py-3 min-w-[200px]">AI ç‰¹æ€§æ¨™ç±¤</th>
                            <th class="px-4 py-3 min-w-[200px]">è³‡è³ªèˆ‡çµæ§‹ç°¡è©•</th>
                            <th class="px-4 py-3 min-w-[250px] text-indigo-700 bg-indigo-50/50">è€ƒå®˜é‡é»å»ºè­°</th>
                            <th class="px-4 py-3 text-right">GPA å¹³å‡</th>
                            <th class="px-4 py-3 text-right text-slate-600">ä¸­ä½æ•¸</th>
                            <th class="px-4 py-3 text-right text-slate-600">æ¨™æº–å·®</th>
                            <th class="px-4 py-3 text-right text-secondary font-semibold">å—éƒ¨å æ¯”</th>
                            <th class="px-4 py-3 text-center">å¥³ç”Ÿæ¯”ä¾‹</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table-body" class="divide-y divide-slate-100">
                        <!-- Rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer class="mt-8 text-center text-slate-400 text-xs pb-8">
            PGY Selection Analytics | Generated by AI Efficiency Partner
        </footer>

    </div>

    <script>
        // --- 1. Configuration & Utils ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4AS_Mdx_cY9qfwgqmRzpg61obLy1J9axVSiTLBtN3_CBK5ciycko2ik_DtsZsMA/pub?gid=879652844&single=true&output=csv';

        const NORTH_CITIES = ['åŸºéš†', 'å°åŒ—', 'è‡ºåŒ—', 'æ–°åŒ—', 'æ¡ƒåœ’', 'æ–°ç«¹', 'è‹—æ —', 'å°ä¸­', 'è‡ºä¸­', 'å½°åŒ–', 'å—æŠ•', 'å®œè˜­'];
        const SOUTH_CITIES = ['é›²æ—', 'å˜‰ç¾©', 'å°å—', 'è‡ºå—', 'é«˜é›„', 'å±æ±']; 

        function getRegion(address) {
            if (!address) return 'Unknown';
            if (NORTH_CITIES.some(c => address.includes(c))) return 'North';
            if (SOUTH_CITIES.some(c => address.includes(c))) return 'South';
            return 'Other';
        }

        function calculateStandardDeviation(array) {
            if (array.length <= 1) return 0;
            const n = array.length;
            const mean = array.reduce((a, b) => a + b) / n;
            return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / (n - 1));
        }

        function calculateMedian(array) {
            const sorted = [...array].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        // --- 2. Data Processing & Logic ---
        async function initDashboard() {
            if (typeof Papa === 'undefined') {
                alert('ç³»çµ±éŒ¯èª¤ï¼šè³‡æºè¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ã€‚');
                return;
            }

            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true, 
                complete: function(results) {
                    processData(results.data);
                },
                error: function(err) {
                    console.error(err);
                    alert("è³‡æ–™è®€å–å¤±æ•—ã€‚");
                }
            });
        }

        function processData(data) {
            const keys = Object.keys(data[0]);
            const findCol = (keywords) => keys.find(k => keywords.some(w => k.toLowerCase().includes(w.toLowerCase())));

            const colSession = findCol(['æ™‚æ®µ', 'session', 'time']); 
            const colGroup = findCol(['çµ„åˆ¥', 'group', 'team']);
            const colGPA = findCol(['gpa', 'æˆç¸¾', 'score']);
            const colCity = findCol(['å±…ä½', 'city', 'address', 'location']);
            const colGender = findCol(['æ€§åˆ¥', 'gender', 'sex']);

            if (!colSession || !colGroup) {
                alert("ç„¡æ³•è­˜åˆ¥åˆ†çµ„æ¬„ä½ï¼Œè«‹æª¢æŸ¥ä¾†æºè³‡æ–™");
                return;
            }

            const groups = {};
            let globalGPA = [];
            let globalSouth = 0, globalNorth = 0;
            let validRowsCount = 0; 

            data.forEach(row => {
                const session = row[colSession]?.trim();
                const groupNum = row[colGroup]?.trim();
                
                if (!session || !groupNum) return;
                
                validRowsCount++; 

                const rawGpa = parseFloat(row[colGPA]);
                const region = getRegion(row[colCity]);
                const gender = row[colGender]?.trim();

                const groupKey = `${session} - ç¬¬${groupNum}çµ„`;

                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        name: groupKey,
                        gpaList: [],
                        southCount: 0,
                        northCount: 0,
                        otherCount: 0,
                        maleCount: 0,
                        femaleCount: 0,
                        totalCount: 0 
                    };
                }

                groups[groupKey].totalCount++;

                if (!isNaN(rawGpa)) {
                    groups[groupKey].gpaList.push(rawGpa);
                    globalGPA.push(rawGpa);
                }

                if (region === 'South') { groups[groupKey].southCount++; globalSouth++; }
                else if (region === 'North') { groups[groupKey].northCount++; globalNorth++; }
                else { groups[groupKey].otherCount++; }

                if (gender && (gender.includes('ç”·') || gender.toLowerCase().startsWith('m'))) groups[groupKey].maleCount++;
                else if (gender && (gender.includes('å¥³') || gender.toLowerCase().startsWith('f'))) groups[groupKey].femaleCount++;
            });

            // Calculate Overall Stats
            const overallMean = globalGPA.length > 0 ? (globalGPA.reduce((a, b) => a + b, 0) / globalGPA.length) : 0;
            const overallSD = globalGPA.length > 0 ? calculateStandardDeviation(globalGPA) : 0;
            
            // Calculate Group Stats first to get avgSD
            let groupStats = Object.values(groups).map(g => {
                const mean = g.gpaList.length > 0 ? (g.gpaList.reduce((a, b) => a + b, 0) / g.gpaList.length) : 0;
                const median = g.gpaList.length > 0 ? calculateMedian(g.gpaList) : 0;
                const sd = g.gpaList.length > 0 ? calculateStandardDeviation(g.gpaList) : 0;
                const total = g.totalCount || 1; 

                return {
                    ...g,
                    mean: mean,
                    median: median,
                    sd: sd,
                    southRatio: (g.southCount / total * 100),
                    northRatio: (g.northCount / total * 100),
                    otherRatio: (g.otherCount / total * 100),
                    maleRatio: (g.maleCount / total * 100),
                    femaleRatio: (g.femaleCount / total * 100),
                };
            });

            // Calculate Global Average SD to determine what is "Stable" vs "Volatile"
            const validSDs = groupStats.map(g => g.sd).filter(sd => sd > 0);
            const globalAvgSD = validSDs.length > 0 ? (validSDs.reduce((a, b) => a + b, 0) / validSDs.length) : 0;

            // --- AI Insight Logic Refined ---
            groupStats.forEach(g => {
                g.tags = [];
                g.insightText = "";

                // 1. Aptitude Analysis (Mean + SD)
                let performance = "";
                if (g.mean > overallMean * 1.02) performance = "High";
                else if (g.mean < overallMean * 0.98) performance = "Low";
                else performance = "Avg";

                let stability = "";
                if (g.sd < globalAvgSD * 0.9) stability = "Stable"; 
                else if (g.sd > globalAvgSD * 1.1) stability = "Volatile"; 
                else stability = "Normal";

                // Generate Tags for Performance/Stability
                if (performance === "High" && stability === "Stable") g.tags.push({text: 'ç¸¾å„ªç©©å®š', type: 'blue'});
                else if (performance === "High") g.tags.push({text: 'ç¸¾å„ªä½†è½å·®å¤§', type: 'amber'});
                else if (performance === "Low" && stability === "Stable") g.tags.push({text: 'ç¨‹åº¦æ™®éåå¼±', type: 'red'});
                else if (performance === "Low") g.tags.push({text: 'æˆç¸¾åå¼±ä¸”ä¸ç©©', type: 'red'});
                else if (stability === "Volatile") g.tags.push({text: 'çµ„å…§è½å·®æ‡¸æ®Š', type: 'amber'});
                // REMOVED: else g.tags.push({text: 'è³‡è³ªå¹³å‡', type: 'slate'});

                // 2. Skewness Analysis (Mean vs Median) - TAGS REMOVED
                const skewThreshold = 0.02;

                // 3. Geography (Only highlight Northern)
                if (g.northRatio > 50) g.tags.push({text: 'åŒ—å€ç”Ÿæº', type: 'slate'});

                // 4. Gender (Pink/Blue logic) - TAGS REMOVED (Handled in table)

                // Construct Text (NO GENDER DESCRIPTION)
                let comments = [];
                
                // Aptitude Comment
                if (performance === "High") comments.push("å¹³å‡å„ªæ–¼å…¨é«”");
                else if (performance === "Low") comments.push("å¹³å‡ä½æ–¼å…¨é«”");
                else comments.push("å¹³å‡èˆ‡å…¨é«”æŒå¹³");

                if (stability === "Stable") comments.push("ä¸”ç¨‹åº¦æ•´é½Š");
                else if (stability === "Volatile") comments.push("ä½†çµ„å…§è½å·®è¼ƒå¤§");
                else comments.push("ä¸”åˆ†ä½ˆå¸¸æ…‹");

                // Skewness Comment
                if (g.mean < g.median * (1 - skewThreshold)) comments.push("ï¼›ç•™æ„å°‘æ•¸ä½åˆ†æ‹‰ä½å‡å€¼");
                else if (g.mean > g.median * (1 + skewThreshold)) comments.push("ï¼›å‡å€¼å—å°‘æ•¸é«˜åˆ†æ‹‰æŠ¬");

                // Geo Comment
                if (g.northRatio > 50) comments.push("ï¼›åŒ—å€è€ƒç”ŸéåŠ");

                g.insightText = comments.join("");
                
                // --- Examiner Recommendation Logic ---
                let recommendation = "";
                if (stability === "Volatile") {
                    recommendation = "âš–ï¸ çµ„å…§è½å·®å¤§ï¼Œè«‹é¢è©¦å®˜å‹™å¿…å›æ­¸çµ•å°æ¨™æº–ï¼Œé¿å…å—å‰å¾Œè€ƒç”Ÿçš„å°æ¯”æ•ˆæ‡‰(Contrast Effect)å½±éŸ¿åˆ¤æ–·ã€‚";
                } else if (performance === "Low") {
                    recommendation = "ğŸ›¡ï¸ æ•´é«”ç¨‹åº¦åå¼±ï¼Œå»ºè­°å¤šè¿½å•è‡¨åºŠæƒ…å¢ƒé¡Œï¼Œåš´æ ¼é‘‘åˆ¥è€ƒç”Ÿçš„åŸºç¤çŸ¥è­˜ã€æŠ—å£“æ€§èˆ‡å—è¨“æ½›åŠ›ã€‚";
                } else if (performance === "High" && stability === "Stable") {
                    recommendation = "ğŸ’ ç¸¾å„ªä¸”ç©©å®šï¼Œå»ºè­°é¢è©¦é‡é»æ”¾åœ¨äººæ ¼ç‰¹è³ªã€æºé€šæŠ€å·§èˆ‡é ˜å°æ½›èƒ½ï¼ŒæŒ–æ˜æ ¸å¿ƒäººæ‰ã€‚";
                } else if (g.mean < g.median * (1 - skewThreshold)) {
                    recommendation = "ğŸ“‰ å—å°‘æ•¸ä½åˆ†æ‹‰ä½å‡å€¼ï¼Œä¸­ä½æ•¸è€ƒç”Ÿç¨‹åº¦å°šå¯ï¼Œè«‹é¿å…å› æ¥µç«¯å€¼å°æ•´çµ„ç”¢ç”Ÿè² é¢å®šéŒ¨ã€‚";
                } else if (g.mean > g.median * (1 + skewThreshold)) {
                    recommendation = "ğŸ“ˆ å—å°‘æ•¸é«˜åˆ†æ‹‰é«˜å‡å€¼ï¼Œè«‹ä»”ç´°æª¢è¦–ä¸­æ®µè€ƒç”Ÿå¯¦éš›èƒ½åŠ›ï¼Œé¿å…é«˜ä¼°æ•´é«”æ°´å¹³ã€‚";
                } else {
                    recommendation = "âœ… è³‡è³ªåˆ†ä½ˆå¸¸æ…‹ï¼Œç¨‹åº¦é©ä¸­ï¼Œå»ºè­°ä¾ç…§æ¨™æº–é¢è©¦çµæ§‹é€²è¡Œç¶œåˆè©•ä¼°å³å¯ã€‚";
                }
                g.examinerNote = recommendation;
            });

            groupStats.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant-TW', { numeric: true }));
            updateUI(groupStats, globalGPA, globalSouth, globalNorth, validRowsCount, overallSD);
        }

        function updateUI(groups, globalGPA, globalSouth, globalNorth, totalCount, overallSD) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-content').classList.remove('opacity-0');

            const overallMean = globalGPA.length > 0 ? (globalGPA.reduce((a, b) => a + b, 0) / globalGPA.length).toFixed(2) : "0.00";
            
            document.getElementById('total-students').innerText = totalCount;
            document.getElementById('overall-gpa').innerText = overallMean;
            document.getElementById('south-ratio').innerText = (globalSouth / totalCount * 100).toFixed(0) + '%';
            // Update Card 4: Overall SD
            document.getElementById('overall-sd').innerText = overallSD.toFixed(2);

            renderCharts(groups);

            const tbody = document.getElementById('stats-table-body');
            tbody.innerHTML = groups.map(g => {
                const tagsHtml = g.tags.map(t => `<span class="tag tag-${t.type}">${t.text}</span>`).join('');
                
                // Gender Color Logic
                let genderClass = "text-slate-500";
                if (g.femaleRatio > 60) genderClass = "text-pink-600 font-bold";
                else if (g.femaleRatio < 40) genderClass = "text-blue-600 font-bold";

                return `
                <tr class="hover:bg-slate-50 transition border-b border-slate-100 last:border-0">
                    <td class="px-4 py-3 font-medium text-primary whitespace-nowrap">${g.name}</td>
                    <td class="px-4 py-3 align-middle">${tagsHtml}</td>
                    <td class="px-4 py-3 text-slate-600 text-xs leading-relaxed">${g.insightText}</td>
                    <td class="px-4 py-3 text-sm text-slate-700 bg-indigo-50/30 border-l border-slate-100">${g.examinerNote}</td>
                    <td class="px-4 py-3 text-right font-bold text-secondary">${g.mean.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right text-slate-600">${g.median.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right text-slate-600">${g.sd.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right text-slate-500 text-amber-700 font-bold">${g.southRatio.toFixed(0)}%</td>
                    <td class="px-4 py-3 text-center ${genderClass}">${g.femaleRatio.toFixed(0)}% (F)</td>
                </tr>
            `}).join('');
        }

        function renderCharts(groups) {
            const labels = groups.map(g => g.name);

            // Chart 1: GPA
            new Chart(document.getElementById('gpaChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'GPA å¹³å‡', data: groups.map(g => g.mean), backgroundColor: '#003566', borderRadius: 4, order: 2 },
                        { label: 'æ¨™æº–å·®', data: groups.map(g => g.sd), type: 'line', borderColor: '#fca311', borderWidth: 2, pointBackgroundColor: '#fff', yAxisID: 'y1', order: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { beginAtZero: false, min: 2.0, title: {display: true, text: 'GPA'} },
                        y1: { type: 'linear', display: true, position: 'right', grid: {drawOnChartArea: false}, title: {display: true, text: 'æ¨™æº–å·® (SD)'} }
                    }
                }
            });

            const ratioTooltip = {
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) label += ': ';
                        let value = context.parsed.y;
                        const group = groups[context.dataIndex];
                        let count = 0;
                        if (context.chart.canvas.id === 'locationChart') {
                            if (context.datasetIndex === 0) count = group.southCount;
                            if (context.datasetIndex === 1) count = group.northCount;
                            if (context.datasetIndex === 2) count = group.otherCount;
                        } else if (context.chart.canvas.id === 'genderChart') {
                            if (context.datasetIndex === 0) count = group.maleCount;
                            if (context.datasetIndex === 1) count = group.femaleCount;
                        }
                        return `${label}${value.toFixed(1)}% (${count}äºº)`;
                    }
                }
            };

            // Chart 2: Location
            new Chart(document.getElementById('locationChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'å—éƒ¨', data: groups.map(g => g.southRatio), backgroundColor: '#fca311' }, 
                        { label: 'åŒ—éƒ¨', data: groups.map(g => g.northRatio), backgroundColor: '#003566' }, 
                        { label: 'å…¶ä»–', data: groups.map(g => g.otherRatio), backgroundColor: '#cbd5e1' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true, max: 100, title: {display: true, text: 'ç™¾åˆ†æ¯” (%)'} } },
                    plugins: { legend: { display: false }, tooltip: ratioTooltip }
                }
            });

            // Chart 3: Gender
            new Chart(document.getElementById('genderChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ç”·æ€§', data: groups.map(g => g.maleRatio), backgroundColor: '#60a5fa' },
                        { label: 'å¥³æ€§', data: groups.map(g => g.femaleRatio), backgroundColor: '#f472b6' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true, max: 100, title: {display: true, text: 'ç™¾åˆ†æ¯” (%)'} } },
                    plugins: { legend: { display: false }, tooltip: ratioTooltip }
                }
            });
        }
        
        function exportTableToCSV() {
            let csv = [];
            csv.push('\uFEFF"ç¾¤é«”åç¨±","ç‰¹æ€§æ¨™ç±¤","åˆ†æç°¡è©•","è€ƒå®˜é‡é»å»ºè­°","GPAå¹³å‡","ä¸­ä½æ•¸","æ¨™æº–å·®","å—éƒ¨å æ¯”(%)","å¥³ç”Ÿå æ¯”(%)"');
            const rows = document.querySelectorAll("#stats-table-body tr");
            rows.forEach(row => {
                const cols = row.querySelectorAll("td");
                const name = cols[0].innerText;
                const tags = Array.from(cols[1].querySelectorAll("span")).map(s => s.innerText).join("; ");
                const insight = cols[2].innerText;
                const examinerNote = cols[3].innerText; // New Column
                const mean = cols[4].innerText;
                const median = cols[5].innerText;
                const sd = cols[6].innerText;
                const south = cols[7].innerText.replace('%', '');
                const female = cols[8].innerText.replace('% (F)', '');
                csv.push(`"${name}","${tags}","${insight}","${examinerNote}","${mean}","${median}","${sd}","${south}","${female}"`);
            });
            let csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
            let downloadLink = document.createElement("a");
            downloadLink.download = "pgy_analysis_advanced.csv";
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }

        window.addEventListener('load', () => { initDashboard(); });
    </script>
</body>
</html>
