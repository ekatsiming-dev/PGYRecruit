<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGY ç”„é¸åˆ†çµ„æˆ°åŠ›åˆ†æ (é›¢ç·šç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #003566;
            background-color: #f0f9ff;
        }
    </style>
</head>
<body class="p-6 md:p-12 text-slate-800">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
            <div>
                <h1 class="text-3xl font-bold text-[#003566] mb-2">PGY ç”„é¸åˆ†çµ„æˆ°åŠ›åˆ†æ</h1>
                <p class="text-slate-500">ç€è¦½å™¨é›¢ç·šç‰ˆï½œè«‹æ‹–å…¥ CSV æª”æ¡ˆä»¥é–‹å§‹åˆ†æ</p>
            </div>
            <div id="global-stats" class="hidden text-right">
                <p class="text-sm text-slate-500">å…¨é«” GPA ä¸­ä½æ•¸åŸºæº–</p>
                <p class="text-2xl font-bold text-[#fca311]" id="global-median">-</p>
            </div>
        </div>

        <!-- File Upload Section -->
        <div id="upload-section" class="card p-12 mb-8 text-center drop-zone cursor-pointer">
            <div class="pointer-events-none">
                <svg class="w-16 h-16 text-slate-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <h3 class="text-xl font-bold text-slate-700 mb-2">å°‡ "MAIN.csv" æª”æ¡ˆæ‹–æ›³è‡³æ­¤</h3>
                <p class="text-slate-500 text-sm">æˆ–é»æ“Šæ­¤è™•é¸æ“‡æª”æ¡ˆ</p>
            </div>
            <input type="file" id="fileInput" class="hidden" accept=".csv">
        </div>

        <!-- Analysis Results (Hidden by default) -->
        <div id="results-section" class="hidden space-y-6">
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="card p-4 border-l-4 border-red-500">
                    <p class="text-xs text-slate-500 font-bold uppercase">ç™¼ç¾æ­»äº¡ä¹‹çµ„</p>
                    <p class="text-2xl font-bold text-slate-800" id="death-count">0</p>
                </div>
                <div class="card p-4 border-l-4 border-yellow-500">
                    <p class="text-xs text-slate-500 font-bold uppercase">ç«¶çˆ­æ¿€çƒˆçµ„åˆ¥</p>
                    <p class="text-2xl font-bold text-slate-800" id="warning-count">0</p>
                </div>
                <div class="card p-4 border-l-4 border-green-500">
                    <p class="text-xs text-slate-500 font-bold uppercase">åˆ†ä½ˆå¹³å‡çµ„åˆ¥</p>
                    <p class="text-2xl font-bold text-slate-800" id="safe-count">0</p>
                </div>
            </div>

            <!-- Main Table -->
            <div class="card overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-white uppercase bg-[#003566]">
                            <tr>
                                <th class="px-6 py-4 cursor-pointer hover:bg-[#004e92]" onclick="sortTable('time')">æ™‚æ®µ</th>
                                <th class="px-6 py-4 cursor-pointer hover:bg-[#004e92]" onclick="sortTable('group')">çµ„åˆ¥</th>
                                <th class="px-6 py-4">äººæ•¸</th>
                                <th class="px-6 py-4 text-center">é¢¨éšªè©•ç´š</th>
                                <th class="px-6 py-4 cursor-pointer hover:bg-[#004e92]" onclick="sortTable('gpa')">GPA ä¸­ä½æ•¸ <span class="opacity-50">â–¼</span></th>
                                <th class="px-6 py-4 cursor-pointer hover:bg-[#004e92]" onclick="sortTable('std')">æ¨™æº–å·® <span class="opacity-50">â–¼</span></th>
                                <th class="px-6 py-4">æ€§åˆ¥åˆ†å¸ƒ (ç”·/å¥³)</th>
                                <th class="px-6 py-4">å—åŒ—åˆ†å¸ƒ (åŒ—/å—)</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-200">
                            <!-- JS will inject rows here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Legend -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6 border-l-4 border-[#fca311]">
                    <h3 class="font-bold text-lg mb-2">ğŸ’¡ åˆ†æé‚è¼¯èªªæ˜</h3>
                    <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                        <li><strong>GPA æ¨™æº–åŒ–ï¼š</strong>è‡ªå‹•åµæ¸¬ä¸¦å°‡ç™¾åˆ†åˆ¶æˆç¸¾ (â‰¥60) è½‰æ›ç‚º 4.3 åˆ¶ã€‚</li>
                        <li><strong>æ­»äº¡ä¹‹çµ„ (ç´…è‰²)ï¼š</strong>è©²çµ„ <span class="text-red-600 font-bold">GPA ä¸­ä½æ•¸ > å…¨é«”å¹³å‡ + 0.5å€‹æ¨™æº–å·®</span>ã€‚</li>
                        <li><strong>ç«¶çˆ­æ¿€åŒ– (é»ƒè‰²)ï¼š</strong><span class="text-amber-600 font-bold">æ¨™æº–å·® < 0.2</span> ä¸”åˆ†æ•¸ä¸­ä¸Š (GPA > 3.5)ã€‚</li>
                    </ul>
                </div>
                <div class="card p-6 border-l-4 border-[#003566]">
                    <h3 class="font-bold text-lg mb-2">ğŸ“Œ ç­–ç•¥å»ºè­°</h3>
                    <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                        <li>è‹¥ã€ŒåŒ—éƒ¨ä½”æ¯”ã€éé«˜ï¼Œå¯èƒ½å­˜åœ¨åŒæ ¡ç¾¤èšæ•ˆæ‡‰ã€‚</li>
                        <li>è‹¥æ¨™æº–å·®éå° (é»ƒè‰²è­¦æˆ’)ï¼Œä»£è¡¨è©²çµ„è€ƒç”Ÿå¯¦åŠ›æ¥µåº¦æ¥è¿‘ï¼Œé¢è©¦è©•åˆ†éœ€æ›´ç´°ç·»ã€‚</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Utility Functions ---

        // GPA Conversion Logic (Matches user's CSV logic)
        function cleanGPA(value) {
            let val = parseFloat(value);
            if (isNaN(val)) return null;
            
            // If already GPA format
            if (val <= 4.3) return val;

            // Percentage to GPA mapping
            if (val >= 90) return 4.3;
            if (val >= 85) return 4.0;
            if (val >= 80) return 3.7;
            if (val >= 77) return 3.3;
            if (val >= 73) return 3.0;
            if (val >= 70) return 2.7;
            if (val >= 67) return 2.3;
            if (val >= 63) return 2.0;
            if (val >= 60) return 1.7;
            return 0.0;
        }

        // Region Categorization
        function categorizeRegion(address) {
            if (!address) return "å…¶ä»–";
            const addr = String(address);
            const north = ['å°åŒ—', 'è‡ºåŒ—', 'æ–°åŒ—', 'åŸºéš†', 'æ¡ƒåœ’', 'æ–°ç«¹', 'å®œè˜­'];
            const south = ['å˜‰ç¾©', 'å°å—', 'è‡ºå—', 'é«˜é›„', 'å±æ±'];
            
            if (north.some(k => addr.includes(k))) return "åŒ—éƒ¨";
            if (south.some(k => addr.includes(k))) return "å—éƒ¨";
            return "å…¶ä»–";
        }

        // Standard Deviation Calculation
        function calculateStd(array) {
            if (!array || array.length === 0) return 0;
            const n = array.length;
            const mean = array.reduce((a, b) => a + b, 0) / n;
            return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / n);
        }

        // Median Calculation
        function calculateMedian(array) {
            if (!array || array.length === 0) return 0;
            const sorted = [...array].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        // --- 2. Main Logic ---
        let processedData = []; // Store for sorting

        const dropZone = document.getElementById('upload-section');
        const fileInput = document.getElementById('fileInput');

        // Drag & Drop Events
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) handleFile(files[0]);
        });
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data);
                }
            });
        }

        function processData(data) {
            // 1. Data Cleaning
            const validData = data.filter(row => row['æ™‚æ®µ'] && row['çµ„åˆ¥']); // Basic validation
            
            // Extract and Normalize GPAs
            validData.forEach(row => {
                // Try 'åœ¨æ ¡æˆç¸¾(GPA)' first, fallback to 'å¹³å‡æˆç¸¾' if needed (though user said GPA column)
                row._gpa = cleanGPA(row['åœ¨æ ¡æˆç¸¾(GPA)']);
                row._region = categorizeRegion(row['é€šè¨Šåœ°å€']);
            });

            // Calculate Global Stats
            const allGPAs = validData.map(r => r._gpa).filter(v => v !== null);
            const globalMedian = calculateMedian(allGPAs);
            const globalStd = calculateStd(allGPAs);

            document.getElementById('global-median').textContent = globalMedian.toFixed(2);
            document.getElementById('global-stats').classList.remove('hidden');

            // 2. Grouping
            const groups = _.groupBy(validData, r => `${r['æ™‚æ®µ']}-${r['çµ„åˆ¥']}`);
            
            processedData = Object.keys(groups).map(key => {
                const groupRows = groups[key];
                const [time, groupNum] = key.split('-');
                const count = groupRows.length;
                
                // GPA Stats
                const groupGPAs = groupRows.map(r => r._gpa).filter(v => v !== null);
                const median = calculateMedian(groupGPAs);
                const std = calculateStd(groupGPAs);

                // Risk Logic
                let risk = 0; // 0: Green, 1: Yellow, 2: Red
                let riskLabel = "ğŸŸ¢ åˆ†å¸ƒå¹³å‡";
                let riskStyle = "background-color: #f0fdf4; color: #166534;";

                if (median > globalMedian + (globalStd * 0.5)) {
                    risk += 2;
                }
                if (std < 0.2 && median > 3.5) {
                    risk += 1;
                }

                if (risk >= 2) {
                    riskLabel = "ğŸ”´ æ­»äº¡ä¹‹çµ„";
                    riskStyle = "background-color: #fee2e2; color: #991b1b;";
                } else if (risk >= 1) {
                    riskLabel = "ğŸŸ¡ ç«¶çˆ­æ¿€çƒˆ";
                    riskStyle = "background-color: #fef9c3; color: #854d0e;";
                }

                // Demographics
                const males = groupRows.filter(r => r['æ€§åˆ¥'] === 'ç”·').length;
                const females = groupRows.filter(r => r['æ€§åˆ¥'] === 'å¥³').length;
                const north = groupRows.filter(r => r._region === 'åŒ—éƒ¨').length;
                const south = groupRows.filter(r => r._region === 'å—éƒ¨').length;

                return {
                    time,
                    groupNum: isNaN(Number(groupNum)) ? groupNum : Number(groupNum),
                    count,
                    median,
                    std,
                    risk, // for sorting
                    riskLabel,
                    riskStyle,
                    males,
                    females,
                    maleRatio: (males/count)*100,
                    north,
                    south,
                    northRatio: (north/count)*100,
                    southRatio: (south/count)*100
                };
            });

            // Sort by Time then Group by default
            processedData.sort((a, b) => {
                if (a.time !== b.time) return a.time.localeCompare(b.time);
                return a.groupNum - b.groupNum;
            });

            updateUI();
        }

        function updateUI() {
            // Update Counts
            document.getElementById('death-count').textContent = processedData.filter(d => d.riskLabel.includes("æ­»äº¡")).length;
            document.getElementById('warning-count').textContent = processedData.filter(d => d.riskLabel.includes("ç«¶çˆ­")).length;
            document.getElementById('safe-count').textContent = processedData.filter(d => d.riskLabel.includes("å¹³å‡")).length;

            // Render Table
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            processedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-200";
                
                // Bars HTML
                const genderBar = `
                    <div class="flex items-center gap-2 text-xs mb-1">
                        <span class="text-blue-600">${row.males}</span>
                        <span class="text-pink-500">${row.females}</span>
                    </div>
                    <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden flex">
                        <div class="bg-blue-500 h-full" style="width: ${row.maleRatio}%"></div>
                        <div class="bg-pink-400 h-full" style="width: ${100-row.maleRatio}%"></div>
                    </div>`;

                const regionBar = `
                    <div class="flex items-center gap-2 text-xs mb-1">
                        <span class="text-indigo-600">åŒ— ${row.north}</span>
                        <span class="text-amber-600">å— ${row.south}</span>
                    </div>
                    <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden flex">
                        <div class="bg-indigo-500 h-full" style="width: ${row.northRatio}%" title="åŒ—éƒ¨"></div>
                        <div class="bg-amber-500 h-full" style="width: ${row.southRatio}%" title="å—éƒ¨"></div>
                        <div class="bg-gray-300 h-full" style="width: ${100-row.northRatio-row.southRatio}%" title="å…¶ä»–"></div>
                    </div>`;

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium">${row.time}</td>
                    <td class="px-6 py-4 font-bold text-lg">${row.groupNum}</td>
                    <td class="px-6 py-4">${row.count}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-bold border" style="${row.riskStyle}">
                            ${row.riskLabel}
                        </span>
                    </td>
                    <td class="px-6 py-4 font-mono font-bold text-[#003566]">${row.median.toFixed(2)}</td>
                    <td class="px-6 py-4 font-mono text-slate-500">${row.std.toFixed(3)}</td>
                    <td class="px-6 py-4">${genderBar}</td>
                    <td class="px-6 py-4">${regionBar}</td>
                `;
                tbody.appendChild(tr);
            });

            // Show Results, Hide Upload
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
        }

        // Sorting (Simple implementation)
        function sortTable(key) {
            if (key === 'gpa') processedData.sort((a, b) => b.median - a.median);
            else if (key === 'std') processedData.sort((a, b) => a.std - b.std); // smaller is simpler
            else if (key === 'group') processedData.sort((a, b) => a.groupNum - b.groupNum);
            else if (key === 'time') processedData.sort((a, b) => a.time.localeCompare(b.time));
            updateUI();
        }

    </script>
</body>
</html>
