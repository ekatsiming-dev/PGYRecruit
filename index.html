<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 PGY 甄選報名資料分析儀表板</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#003566', // Deep Blue
                        secondary: '#fca311', // Amber
                        accent: '#fef9c3', // Light Yellow
                        bg: '#f8fafc', // Slate 50
                        surface: '#ffffff',
                        success: '#10b981', // Emerald
                        danger: '#ef4444', // Red
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #fca311; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Tag Styles */
        .tag { padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; margin-right: 4px; display: inline-block; margin-bottom: 2px;}
        .tag-blue { background: #e0f2fe; color: #0369a1; }
        .tag-amber { background: #fef3c7; color: #b45309; }
        .tag-green { background: #d1fae5; color: #047857; }
        .tag-slate { background: #f1f5f9; color: #475569; }
        .tag-red { background: #fee2e2; color: #b91c1c; }
        .tag-pink { background: #fce7f3; color: #be185d; } /* New Pink Style */
    </style>
</head>
<body class="text-slate-800">

    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-primary/90 z-50 flex flex-col items-center justify-center text-white">
        <div class="loading-spinner mb-4"></div>
        <h2 class="text-xl font-bold">正在讀取 2026 PGY 甄選資料...</h2>
        <p class="text-sm opacity-80 mt-2">分析樣本總數：235</p>
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 py-8 opacity-0 transition-opacity duration-700" id="main-content">
        
        <!-- Header -->
        <header class="mb-8 border-l-4 border-secondary pl-4 flex flex-col md:flex-row md:justify-between md:items-end">
            <div>
                <h1 class="text-3xl font-bold text-primary">2026 PGY 甄選報名資料分析儀表板</h1>
                <p class="text-slate-500 mt-1">深度資質分析：均值/中位數偏態偵測 | 性別結構 | 北部生源偵測</p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <span class="text-xs bg-primary text-white px-2 py-1 rounded">2026 Selection</span>
            </div>
        </header>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card p-6 border-t-4 border-primary">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">總樣本數 (有效組別)</p>
                        <h3 class="text-3xl font-bold text-primary mt-1" id="total-students">0</h3>
                    </div>
                    <div class="p-2 bg-blue-50 rounded-lg text-primary">
                        <i class="ph ph-users text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="card p-6 border-t-4 border-secondary">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">全體 GPA 平均</p>
                        <h3 class="text-3xl font-bold text-secondary mt-1" id="overall-gpa">0.00</h3>
                    </div>
                    <div class="p-2 bg-amber-50 rounded-lg text-secondary">
                        <i class="ph ph-exam text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="card p-6 border-t-4 border-secondary">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">南部生源總佔比</p>
                        <h3 class="text-3xl font-bold text-secondary mt-1" id="south-ratio">0%</h3>
                        <p class="text-xs text-slate-400 mt-1">包含台南及其他南部</p>
                    </div>
                    <div class="p-2 bg-amber-50 rounded-lg text-secondary">
                        <i class="ph ph-house-line text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="card p-6 border-t-4 border-slate-400">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">全體 GPA 標準差</p>
                        <h3 class="text-3xl font-bold text-slate-600 mt-1" id="overall-sd">0.00</h3>
                        <p class="text-xs text-slate-400 mt-1">數值越低代表素質越整齊</p>
                    </div>
                    <div class="p-2 bg-slate-100 rounded-lg text-slate-600">
                        <i class="ph ph-activity text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section 1: Performance -->
        <div class="card p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-primary flex items-center">
                    <i class="ph ph-trend-up mr-2"></i> 各組成績 GPA 資質分析
                </h3>
                <div class="flex gap-2">
                     <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">長條：平均 GPA</span>
                     <span class="text-xs px-2 py-1 bg-amber-100 text-amber-800 rounded">折線：標準差</span>
                </div>
            </div>
            <div class="relative h-64">
                <canvas id="gpaChart"></canvas>
            </div>
            <p class="text-xs text-slate-400 mt-2 text-center">*標準差 (折線) 越低代表該組成績越整齊，越高代表落差越大</p>
        </div>

        <!-- Chart Section 2: Demographics (Side by Side) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            
            <!-- Location Distribution -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-primary flex items-center">
                        <i class="ph ph-map-trifold mr-2"></i> 居住地源比率(100%)
                    </h3>
                </div>
                <div class="relative h-72">
                    <canvas id="locationChart"></canvas>
                </div>
                <div class="flex flex-wrap justify-center gap-2 mt-2 text-xs text-slate-500">
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-[#fca311] mr-1"></div>南部 (含台南)</span>
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-[#003566] mr-1"></div>北部</span>
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-[#cbd5e1] mr-1"></div>其他</span>
                </div>
                <p class="text-xs text-center text-slate-400 mt-2">* 懸停圖表可查看實際人數</p>
            </div>

            <!-- Gender Distribution -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-primary flex items-center">
                        <i class="ph ph-gender-intersex mr-2"></i> 各組性別比率 (100%)
                    </h3>
                </div>
                <div class="relative h-72">
                    <canvas id="genderChart"></canvas>
                </div>
                 <div class="flex justify-center gap-4 mt-2 text-xs text-slate-500">
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-[#60a5fa] mr-1"></div>男性</span>
                    <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-[#f472b6] mr-1"></div>女性</span>
                </div>
                <p class="text-xs text-center text-slate-400 mt-2">* 懸停圖表可查看實際人數</p>
            </div>
        </div>

        <!-- Insight & Stats Table -->
        <div class="card overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h3 class="text-lg font-bold text-primary flex items-center">
                        <i class="ph ph-lightning mr-2 text-secondary"></i> PGY 各組特性智能分析
                    </h3>
                    <p class="text-xs text-slate-400 mt-1">包含資質偏態分析(均值vs中位數)、性別與地緣特性</p>
                </div>
                <button onclick="exportTableToCSV()" class="text-sm bg-primary text-white px-4 py-2 rounded hover:bg-blue-800 transition shadow-sm">
                    <i class="ph ph-download-simple mr-1"></i> 匯出分析報告
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                        <tr>
                            <th class="px-4 py-3 min-w-[100px]">群體名稱</th>
                            <th class="px-4 py-3 min-w-[200px]">AI 特性標籤</th>
                            <th class="px-4 py-3 min-w-[250px]">資質與結構簡評</th>
                            <th class="px-4 py-3 text-right">GPA 平均</th>
                            <th class="px-4 py-3 text-right text-slate-600">中位數</th>
                            <th class="px-4 py-3 text-right text-slate-600">標準差</th>
                            <th class="px-4 py-3 text-right text-secondary font-semibold">南部占比</th>
                            <th class="px-4 py-3 text-center">女生比例</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table-body" class="divide-y divide-slate-100">
                        <!-- Rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer class="mt-8 text-center text-slate-400 text-xs pb-8">
            PGY Selection Analytics | Generated by AI Efficiency Partner
        </footer>

    </div>

    <script>
        // --- 1. Configuration & Utils ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4AS_Mdx_cY9qfwgqmRzpg61obLy1J9axVSiTLBtN3_CBK5ciycko2ik_DtsZsMA/pub?gid=879652844&single=true&output=csv';

        const NORTH_CITIES = ['基隆', '台北', '臺北', '新北', '桃園', '新竹', '苗栗', '台中', '臺中', '彰化', '南投', '宜蘭'];
        const SOUTH_CITIES = ['雲林', '嘉義', '台南', '臺南', '高雄', '屏東']; 

        function getRegion(address) {
            if (!address) return 'Unknown';
            if (NORTH_CITIES.some(c => address.includes(c))) return 'North';
            if (SOUTH_CITIES.some(c => address.includes(c))) return 'South';
            return 'Other';
        }

        function calculateStandardDeviation(array) {
            if (array.length <= 1) return 0;
            const n = array.length;
            const mean = array.reduce((a, b) => a + b) / n;
            return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / (n - 1));
        }

        function calculateMedian(array) {
            const sorted = [...array].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        // --- 2. Data Processing & Logic ---
        async function initDashboard() {
            if (typeof Papa === 'undefined') {
                alert('系統錯誤：資源載入失敗，請重新整理。');
                return;
            }

            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true, 
                complete: function(results) {
                    processData(results.data);
                },
                error: function(err) {
                    console.error(err);
                    alert("資料讀取失敗。");
                }
            });
        }

        function processData(data) {
            const keys = Object.keys(data[0]);
            const findCol = (keywords) => keys.find(k => keywords.some(w => k.toLowerCase().includes(w.toLowerCase())));

            const colSession = findCol(['時段', 'session', 'time']); 
            const colGroup = findCol(['組別', 'group', 'team']);
            const colGPA = findCol(['gpa', '成績', 'score']);
            const colCity = findCol(['居住', 'city', 'address', 'location']);
            const colGender = findCol(['性別', 'gender', 'sex']);

            if (!colSession || !colGroup) {
                alert("無法識別分組欄位，請檢查來源資料");
                return;
            }

            const groups = {};
            let globalGPA = [];
            let globalSouth = 0, globalNorth = 0;
            let validRowsCount = 0; 

            data.forEach(row => {
                const session = row[colSession]?.trim();
                const groupNum = row[colGroup]?.trim();
                
                if (!session || !groupNum) return;
                
                validRowsCount++; 

                const rawGpa = parseFloat(row[colGPA]);
                const region = getRegion(row[colCity]);
                const gender = row[colGender]?.trim();

                const groupKey = `${session} - 第${groupNum}組`;

                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        name: groupKey,
                        gpaList: [],
                        southCount: 0,
                        northCount: 0,
                        otherCount: 0,
                        maleCount: 0,
                        femaleCount: 0,
                        totalCount: 0 
                    };
                }

                groups[groupKey].totalCount++;

                if (!isNaN(rawGpa)) {
                    groups[groupKey].gpaList.push(rawGpa);
                    globalGPA.push(rawGpa);
                }

                if (region === 'South') { groups[groupKey].southCount++; globalSouth++; }
                else if (region === 'North') { groups[groupKey].northCount++; globalNorth++; }
                else { groups[groupKey].otherCount++; }

                if (gender && (gender.includes('男') || gender.toLowerCase().startsWith('m'))) groups[groupKey].maleCount++;
                else if (gender && (gender.includes('女') || gender.toLowerCase().startsWith('f'))) groups[groupKey].femaleCount++;
            });

            // Calculate Overall Stats
            const overallMean = globalGPA.length > 0 ? (globalGPA.reduce((a, b) => a + b, 0) / globalGPA.length) : 0;
            const overallSD = globalGPA.length > 0 ? calculateStandardDeviation(globalGPA) : 0;
            
            // Calculate Group Stats first to get avgSD
            let groupStats = Object.values(groups).map(g => {
                const mean = g.gpaList.length > 0 ? (g.gpaList.reduce((a, b) => a + b, 0) / g.gpaList.length) : 0;
                const median = g.gpaList.length > 0 ? calculateMedian(g.gpaList) : 0;
                const sd = g.gpaList.length > 0 ? calculateStandardDeviation(g.gpaList) : 0;
                const total = g.totalCount || 1; 

                return {
                    ...g,
                    mean: mean,
                    median: median,
                    sd: sd,
                    southRatio: (g.southCount / total * 100),
                    northRatio: (g.northCount / total * 100),
                    otherRatio: (g.otherCount / total * 100),
                    maleRatio: (g.maleCount / total * 100),
                    femaleRatio: (g.femaleCount / total * 100),
                };
            });

            // Calculate Global Average SD to determine what is "Stable" vs "Volatile"
            const validSDs = groupStats.map(g => g.sd).filter(sd => sd > 0);
            const globalAvgSD = validSDs.length > 0 ? (validSDs.reduce((a, b) => a + b, 0) / validSDs.length) : 0;

            // --- AI Insight Logic Refined ---
            groupStats.forEach(g => {
                g.tags = [];
                g.insightText = "";

                // 1. Aptitude Analysis (Mean + SD)
                let performance = "";
                if (g.mean > overallMean * 1.02) performance = "High";
                else if (g.mean < overallMean * 0.98) performance = "Low";
                else performance = "Avg";

                let stability = "";
                if (g.sd < globalAvgSD * 0.9) stability = "Stable"; 
                else if (g.sd > globalAvgSD * 1.1) stability = "Volatile"; 
                else stability = "Normal";

                // Generate Tags for Performance/Stability
                if (performance === "High" && stability === "Stable") g.tags.push({text: '績優穩定', type: 'blue'});
                else if (performance === "High") g.tags.push({text: '績優但落差大', type: 'amber'});
                else if (performance === "Low" && stability === "Stable") g.tags.push({text: '程度普遍偏弱', type: 'red'});
                else if (performance === "Low") g.tags.push({text: '成績偏弱且不穩', type: 'red'});
                else if (stability === "Volatile") g.tags.push({text: '組內落差懸殊', type: 'amber'});
                // REMOVED: else g.tags.push({text: '資質平均', type: 'slate'});

                // 2. Skewness Analysis (Mean vs Median) - TAGS REMOVED
                const skewThreshold = 0.02;

                // 3. Geography (Only highlight Northern)
                if (g.northRatio > 50) g.tags.push({text: '北區生源', type: 'slate'});

                // 4. Gender (Pink/Blue logic) - TAGS REMOVED (Handled in table)

                // Construct Text (NO GENDER DESCRIPTION)
                let comments = [];
                
                // Aptitude Comment
                if (performance === "High") comments.push("平均優於全體");
                else if (performance === "Low") comments.push("平均低於全體");
                else comments.push("平均與全體持平");

                if (stability === "Stable") comments.push("且程度整齊");
                else if (stability === "Volatile") comments.push("但組內落差較大");
                else comments.push("且分佈常態");

                // Skewness Comment
                if (g.mean < g.median * (1 - skewThreshold)) comments.push("；留意少數低分拉低均值");
                else if (g.mean > g.median * (1 + skewThreshold)) comments.push("；均值受少數高分拉抬");

                // Geo Comment
                if (g.northRatio > 50) comments.push("；北區考生過半");

                g.insightText = comments.join("");
            });

            groupStats.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant-TW', { numeric: true }));
            updateUI(groupStats, globalGPA, globalSouth, globalNorth, validRowsCount, overallSD);
        }

        function updateUI(groups, globalGPA, globalSouth, globalNorth, totalCount, overallSD) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-content').classList.remove('opacity-0');

            const overallMean = globalGPA.length > 0 ? (globalGPA.reduce((a, b) => a + b, 0) / globalGPA.length).toFixed(2) : "0.00";
            
            document.getElementById('total-students').innerText = totalCount;
            document.getElementById('overall-gpa').innerText = overallMean;
            document.getElementById('south-ratio').innerText = (globalSouth / totalCount * 100).toFixed(0) + '%';
            // Update Card 4: Overall SD
            document.getElementById('overall-sd').innerText = overallSD.toFixed(2);

            renderCharts(groups);

            const tbody = document.getElementById('stats-table-body');
            tbody.innerHTML = groups.map(g => {
                const tagsHtml = g.tags.map(t => `<span class="tag tag-${t.type}">${t.text}</span>`).join('');
                
                // Gender Color Logic
                let genderClass = "text-slate-500";
                if (g.femaleRatio > 60) genderClass = "text-pink-600 font-bold";
                else if (g.femaleRatio < 40) genderClass = "text-blue-600 font-bold";

                return `
                <tr class="hover:bg-slate-50 transition border-b border-slate-100 last:border-0">
                    <td class="px-4 py-3 font-medium text-primary whitespace-nowrap">${g.name}</td>
                    <td class="px-4 py-3 align-middle">${tagsHtml}</td>
                    <td class="px-4 py-3 text-slate-600 text-xs leading-relaxed">${g.insightText}</td>
                    <td class="px-4 py-3 text-right font-bold text-secondary">${g.mean.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right text-slate-600">${g.median.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right text-slate-600">${g.sd.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right text-slate-500 text-amber-700 font-bold">${g.southRatio.toFixed(0)}%</td>
                    <td class="px-4 py-3 text-center ${genderClass}">${g.femaleRatio.toFixed(0)}% (F)</td>
                </tr>
            `}).join('');
        }

        function renderCharts(groups) {
            const labels = groups.map(g => g.name);

            // Chart 1: GPA
            new Chart(document.getElementById('gpaChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'GPA 平均', data: groups.map(g => g.mean), backgroundColor: '#003566', borderRadius: 4, order: 2 },
                        { label: '標準差', data: groups.map(g => g.sd), type: 'line', borderColor: '#fca311', borderWidth: 2, pointBackgroundColor: '#fff', yAxisID: 'y1', order: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { beginAtZero: false, min: 2.0, title: {display: true, text: 'GPA'} },
                        y1: { type: 'linear', display: true, position: 'right', grid: {drawOnChartArea: false}, title: {display: true, text: '標準差 (SD)'} }
                    }
                }
            });

            const ratioTooltip = {
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) label += ': ';
                        let value = context.parsed.y;
                        const group = groups[context.dataIndex];
                        let count = 0;
                        if (context.chart.canvas.id === 'locationChart') {
                            if (context.datasetIndex === 0) count = group.southCount;
                            if (context.datasetIndex === 1) count = group.northCount;
                            if (context.datasetIndex === 2) count = group.otherCount;
                        } else if (context.chart.canvas.id === 'genderChart') {
                            if (context.datasetIndex === 0) count = group.maleCount;
                            if (context.datasetIndex === 1) count = group.femaleCount;
                        }
                        return `${label}${value.toFixed(1)}% (${count}人)`;
                    }
                }
            };

            // Chart 2: Location
            new Chart(document.getElementById('locationChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '南部', data: groups.map(g => g.southRatio), backgroundColor: '#fca311' }, 
                        { label: '北部', data: groups.map(g => g.northRatio), backgroundColor: '#003566' }, 
                        { label: '其他', data: groups.map(g => g.otherRatio), backgroundColor: '#cbd5e1' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true, max: 100, title: {display: true, text: '百分比 (%)'} } },
                    plugins: { legend: { display: false }, tooltip: ratioTooltip }
                }
            });

            // Chart 3: Gender
            new Chart(document.getElementById('genderChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '男性', data: groups.map(g => g.maleRatio), backgroundColor: '#60a5fa' },
                        { label: '女性', data: groups.map(g => g.femaleRatio), backgroundColor: '#f472b6' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true, max: 100, title: {display: true, text: '百分比 (%)'} } },
                    plugins: { legend: { display: false }, tooltip: ratioTooltip }
                }
            });
        }
        
        function exportTableToCSV() {
            let csv = [];
            csv.push('\uFEFF"群體名稱","特性標籤","分析簡評","GPA平均","中位數","標準差","南部占比(%)","女生占比(%)"');
            const rows = document.querySelectorAll("#stats-table-body tr");
            rows.forEach(row => {
                const cols = row.querySelectorAll("td");
                const name = cols[0].innerText;
                const tags = Array.from(cols[1].querySelectorAll("span")).map(s => s.innerText).join("; ");
                const insight = cols[2].innerText;
                const mean = cols[3].innerText;
                const median = cols[4].innerText;
                const sd = cols[5].innerText;
                const south = cols[6].innerText.replace('%', '');
                const female = cols[7].innerText.replace('% (F)', '');
                csv.push(`"${name}","${tags}","${insight}","${mean}","${median}","${sd}","${south}","${female}"`);
            });
            let csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
            let downloadLink = document.createElement("a");
            downloadLink.download = "pgy_analysis_advanced.csv";
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }

        window.addEventListener('load', () => { initDashboard(); });
    </script>
</body>
</html>
